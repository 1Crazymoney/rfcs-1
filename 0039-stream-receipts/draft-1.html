<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Payments across payment networks">

    <title>STREAM Receipts | Interledger</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Custom styles -->
    <link href="/assets/css/monokai-sublime.css" rel="stylesheet">
    <link href="/assets/css/custom.css" rel="stylesheet">

    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,600,700|Droid+Sans+Mono|Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>

    <!-- Font awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css">

    <link href="/assets/favicon.ico" rel="icon" type="image/x-icon">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body data-spy="scroll" data-target="#myScrollspy" data-offset="160" class="spec sidebar-primary">

     <!-- navbar -->
     <nav class="navbar fixed-top navbar-expand-lg navbar-dark nav-innerpage">
        <div class="navbar-leftbg"><a href="/" class="navbar-brand"><img src="/assets/img/ilp_logo@2x.png" class="logo"  height="44" alt="Interledger" /></a></div>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarHolder" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">

          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarHolder">
          <ul class="nav navbar-nav">
                <li class="nav-item" ><a class="nav-link" href="/overview.html">Docs</a></li>
                <li class="nav-item" ><a class="nav-link" href="/libraries.html">Tools</a></li>
                <li class="nav-item" ><a class="nav-link" href="/community.html">Community</a></li>
                <li class="nav-item"><a class="nav-link" target="_blank" href="https://github.com/interledger">Edit on Github</a></li>
                <li class="nav-item"><a class="nav-link cornerlink" href="/getting-started.html">Get Started</a></li>
          </ul><!-- /.navbar-nav -->
          <div class="cornerbox"></div>
        </div>
        <div class="menu-overlay"></div>
    </nav>

    <!-- docs overview section -->

    <div class="container-fluid ">
      <div class="row">

        <!-- Left nav -->
        <aside class="sidebar col-md-4 col-lg-3 p-0 order-md-1" role="complementary">
            <div id="sidenav" class="tree_nav">
              <ul class=" sidebar_pagelist ">
                <li class="nav-label">Quick Start</li>
                <li><a href="/overview.html">Overview</a></li>
                <li><a href="/getting-started.html">Getting Started</a></li>
                <ul>
                    <li><a href="/sending-value-programmatically.html">Sending Value Programmatically</a></li>
                    <li><a href="/connect-ilp-testnet.html">Connect to an ILP Tesnet</a></li>
                </ul>
              </ul>
              <ul class=" sidebar_pagelist">
                <li class="nav-label">Community Resources</li>
                <li><a class="external-link" href="https://medium.com/interledger-blog">Blog and Tutorials<i class="fa fa-external-link" aria-hidden="true"></i></a></li>
                <li><a href="/libraries.html">Libraries and Tools</a></li>
                <li><a href="/summit-2019.html">ILP Summit 2019 Videos</a></li>
              </ul>

              <div class="sidebar-nav-header">Specs</div>
              <ul class=" sidebar_pagelist sidebar_indent">
                <li><a href="/rfcs/0027-interledger-protocol-4/">Interledger Protocol 4 (ILPv4)</a></li>
                <li><a href="/rfcs/0015-ilp-addresses/">Interledger Addresses</a></li>
                <li><a href="/rfcs/0029-stream/">STREAM Protocol</a></li>
                <li><a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol (SPSP)</a></li>
                <li><a href="/rfcs/0030-notes-on-oer-encoding/">Notes on OER encoding</a></li>
                <li><a href="/rfcs/0031-dynamic-configuration-protocol/">Dynamic Configuration Protocol (ILDCP)</a></li>
                <li><a href="/rfcs/0038-settlement-engines/">Settlement Engines</a></li>
                <li><a href="/rfcs/0032-peering-clearing-settlement/">Peering, Clearing and Settlement</a></li>
                <li><a href="/rfcs/0035-ilp-over-http/">ILP over HTTP</a></li>
                <li><a href="/rfcs/0036-spsp-pull-payments/">SPSP Pull Payments</a></li>
                <li>&nbsp;</li>
                <li><a class="external-link" target="_blank" href="https://paymentpointers.org">Payment Pointers</a></li>
                <li><a class="external-link" target="_blank" href="https://webmonetization.org">Web Monetization</a></li>
                <li><a class="external-link" target="_blank" href="https://w3c.github.io/webpayments/proposals/interledger-payment-method.html">W3C Web Payments</a></li>
              </ul>
            </div>
          </aside>
        <!-- End Left nav -->

        <!-- Right sidebar -->
      <aside class="right-sidebar col-lg-3 order-lg-4 p-0" role="complementary">
        <!-- <div id="sidebarContent"> -->
            <div class="card" id="page-toc-wrapper">
          <!-- <nav class="col-sm-4" id="myScrollspy"> -->
              <div class="card-header">
                  <h4>On This Page</h4>
                </div>
            <ul class="card-body">
              <!-- <div class="overview-back"><a href="/overview.html"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Back to Overview</a></div> -->
                <li class="nav-label">
                  <a href="./draft-1.html">ILP-RFC 0039 Draft 1</a>
                </li>
                <li>
                  <a href="./draft-1.html">Permalink to this Draft</a>
                </li>
                <li>
                  <a href="./">View the Latest Draft of ILP-RFC 0039</a>
                </li>
              
                <li class="level-2">
                  <a href="#motivation">Motivation</a>
                </li>
              
                <li class="level-2">
                  <a href="#conventions-and-definitions">Conventions and Definitions</a>
                </li>
              
                <li class="level-2">
                  <a href="#overview">Overview</a>
                </li>
              
                <li class="level-3">
                  <a href="#flow">Flow</a>
                </li>
              
                <li class="level-3">
                  <a href="#stateless-verifier">Stateless Verifier</a>
                </li>
              
                <li class="level-3">
                  <a href="#stateless-receiver">Stateless Receiver</a>
                </li>
              
                <li class="level-3">
                  <a href="#spsp">SPSP</a>
                </li>
              
                <li class="level-3">
                  <a href="#web-monetization">Web Monetization</a>
                </li>
              
                <li class="level-2">
                  <a href="#specification">Specification</a>
                </li>
              
            </ul>
            </div>
        <!-- </div> -->
        </aside>
        <!-- End Right sidebar -->

        <!-- Center -->
        <div class="main col-md-8  col-lg-6   order-md-3  " role="main" id="main_content_body">
                      <h1 id="stream-receipts">STREAM Receipts</h1>
<blockquote>
<p class="intro">Proof provided by a <a href="../0029-stream">STREAM</a> receiver of the total amount received on a stream.</p>
</blockquote>
<h2 id="motivation">Motivation</h2>
<p>Interledger payment verification is necessary for multiple use cases including Web Monetization, where ILP payments must be verified to securely serve exclusive content, and API micropayments.</p>
<p>Standardized receipt functionality at the STREAM layer enables the payment recipient or a third party to verify payment without having access to the corresponding ILP packets.</p>
<h2 id="conventions-and-definitions">Conventions and Definitions</h2>
<p>The key words &#x201C;MUST&#x201D;, &#x201C;MUST NOT&#x201D;, &#x201C;REQUIRED&#x201D;, &#x201C;SHALL&#x201D;, &#x201C;SHALL NOT&#x201D;, &#x201C;SHOULD&#x201D;, &#x201C;SHOULD NOT&#x201D;, &#x201C;RECOMMENDED&#x201D;, &#x201C;NOT RECOMMENDED&#x201D;, &#x201C;MAY&#x201D;, and &#x201C;OPTIONAL&#x201D; in this document are to be interpreted as described in BCP 14 <a href="https://tools.ietf.org/html/rfc2119">RFC2119</a> <a href="https://tools.ietf.org/html/rfc8174">RFC8174</a> when, and only when, they appear in all capitals, as shown here.</p>
<p>Definitions of terms that are used in this document:</p>
<ul>
<li><strong>Receiver</strong> - The party that is receiving funds over STREAM</li>
<li><strong>Verifier</strong> - The party that wishes to verify that ILP payments occurred to the Receiver</li>
<li><strong>Sender</strong> - The party that is sending funds over STREAM</li>
<li><strong>Receipt Nonce</strong> - A unique nonce used to identify a STREAM connection in a Receipt</li>
<li><strong>Receipt Secret</strong> - The key used to generate a Receipt&apos;s HMAC</li>
<li><strong>Receipt</strong> - A binary object containing a version number, the Receipt Nonce, a Stream ID on the STREAM connection, an integer amount of funds received on a stream, and an HMAC over all those fields</li>
</ul>
<h2 id="overview">Overview</h2>
<p>In a STREAM connection, a Receipt is generated by the Receiver for every fulfilled ILP packet. Each Receipt on a stream contains a progressively higher amount, representing the total amount received on that stream. So the latest Receipt on a stream replaces any previous Receipts on that stream.</p>
<p>The Verifier SHOULD consider a Receipt valid if:</p>
<ul>
<li>The Receipt contents produce an HMAC (using the Receipt Secret as the seed) identical to the Receipt&apos;s HMAC field.</li>
<li>The amount is greater than any other Receipts with that Receipt Nonce and Stream ID.</li>
<li>The Receipt is not stale.</li>
</ul>
<p>The Verifier SHOULD determine a length of time starting from when a Receipt Nonce is generated that corresponding Receipts will be considered valid. Mechanisms by which the Verifier can check Receipts&apos; staleness include, but are not limited to:</p>
<ul>
<li>persistently storing the Receipt Nonce and a timestamp relative to when the Nonce was generated</li>
<li>encoding a timestamp in the Receipt Nonce</li>
</ul>
<p>If keeping a balance of how much the Sender has paid, the Verifier SHOULD store the Receipt amount under the Receipt Nonce + Stream ID. If there is already an amount stored for that Stream ID, the Verifier SHOULD only credit the Sender the difference in Receipt amounts.</p>
<p>Alteratively, the Verifier MAY forego checking the Receipt amount if they are only concerned with whether or not the Sender paid at all, as opposed to how much.</p>
<h3 id="flow">Flow</h3>
<p>This flow occurs for each STREAM connection with Receipts enabled.</p>
<ol>
<li><p>Verifier MUST generate a unique Receipt Nonce.</p>
</li>
<li><p>Verifier MUST communicate the Receipt Nonce and Receipt Secret to the Receiver. The Receipt Secret MUST NOT be communicated to the Sender.</p>
</li>
<li><p>Once the STREAM connection is open and the Sender is sending, the Receiver MUST add an additional frame containing a Receipt to each ILP Fulfill packet.</p>
</li>
<li><p>Sender MUST give the Receipt directly or indirectly to the Verifier.</p>
</li>
<li><p>Verifier MUST verify the Receipt before accepting the Receipt amount as paid.</p>
</li>
</ol>
<h3 id="stateless-verifier">Stateless Verifier</h3>
<p>The Verifier MAY generate the Receipt Secret by producing an HMAC of the Receipt Nonce using a seed (known only to itself) as the HMAC key. This ensures the Receipt Secret will be unique to this STREAM connection and allows the Verifier to reproduce the Receipt Secret from any Receipts containing the Receipt Nonce.</p>
<h3 id="stateless-receiver">Stateless Receiver</h3>
<p>Before a STREAM connection is established, the Receiver MAY use the Receipt Nonce and Receipt Secret as parameters to generate connection details (ILP Address and shared secret). The Receiver MAY encode the Receipt Nonce and Receipt Secret in the STREAM server ILP Address to allow the STREAM receiver to avoid persisting state. If doing so, the Receipt Secret MUST be encrypted. The Receipt Nonce MUST be unique each time STREAM parameters are generated, since it MUST be unique globally.</p>
<h3 id="spsp">SPSP</h3>
<p>The Verifier MAY communicate the Receipt Nonce and Receipt Secret to the Receiver by proxying the Sender&apos;s <a href="../0009-simple-payment-setup-protocol">SPSP</a> query, as follows:</p>
<ol>
<li>Sender queries the Verifier&apos;s payment pointer URL.</li>
<li>Verifier MUST add the Receipt Nonce and Receipt Secret to the request in <code>Receipt-Nonce</code> and <code>Receipt-Secret</code> headers.</li>
<li>Verifier MUST pass the query to the Receiver.</li>
<li>Receiver MUST include <code>&quot;receipts_enabled&quot;: true</code> in a successful SPSP response.</li>
<li>Verifier MAY return a <code>409</code> error code if the response does not include <code>&quot;receipts_enabled&quot;: true</code>. Otherwise, the Verifier MUST return the SPSP response to the Sender.</li>
</ol>
<h3 id="web-monetization">Web Monetization</h3>
<p>A <a href="https://webmonetization.org/specification.html">Web Monetization</a> Sender MUST include each ILP Fulfill packet&apos;s Receipt in the corresponding <code>monetizationprogress</code> event. This allows the webpage to pass Receipts to the Verifier.</p>
<h2 id="specification">Specification</h2>
<p>A Receipt MUST contain the following fields encoded using <a href="https://github.com/interledger/rfcs/blob/master/0030-notes-on-oer-encoding/0030-notes-on-oer-encoding.md#canonical-oer">CANONICAL-OER</a> (find more details <a href="https://github.com/interledger/rfcs/blob/05ab457b9301b031e1ec954632582a325c4907b4/asn1/README.md">here</a>):</p>
<table class="table table-striped">
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Version</td>
<td>UInt8</td>
<td><code>1</code> for this version.</td>
</tr>
<tr>
<td>Receipt Nonce</td>
<td>UInt128</td>
<td>A unique nonce pre-shared between the Verifier and the Receiver used to identify the STREAM connection.</td>
</tr>
<tr>
<td>Stream ID</td>
<td>UInt8</td>
<td>Identifier of the stream this Receipt refers to.</td>
</tr>
<tr>
<td>Total Received</td>
<td>UInt64</td>
<td>Total amount, denominated in the units of the Receiver, that the Receiver has received on this stream thus far.</td>
</tr>
<tr>
<td>HMAC</td>
<td>UInt256</td>
<td>HMAC-SHA256 using the 32 byte Receipt Secret, which is pre-shared between the Verifier and the Receiver. The HMAC message is the concatenation of all other Receipt fields, in the order listed above.</td>
</tr>
</tbody>
</table>

        </div>
        <!-- End Center -->
      </div>

    </div> <!-- /container -->

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-sm-9 col-xs-12 float-left footertext">
                        <p><img src="/assets/img/ilp_footer_logo@2x.png" height="44" alt="Interledger" align="left" /> Interledger Project<br><span>Documentation licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0.</a></span></p>
                    </div>
                    <div class="col-sm-3 col-xs-12 float-right">
                        <a href="https://twitter.com/interledger"><img src="/assets/img/Twitter.png"></a>
                        <a href="https://communityinviter.com/apps/interledger/interledger-working-groups-slack"><img src="/assets/img/Slack.png"></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/highlight.pack.js"></script>
    <script src="/assets/js/custom.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68500608-1', 'auto');
      ga('send', 'pageview');

    </script>

  </body>
</html>

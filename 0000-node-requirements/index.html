<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Payments across payment networks">

    <title>Interledger Connector - Requirements Specification | Interledger</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles -->
    <link href="/css/monokai-sublime.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,600,700|Droid+Sans+Mono|Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>

    <!-- Font awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css">

    <link href="/assets/favicon.ico" rel="icon" type="image/x-icon">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body data-spy="scroll" data-target="#myScrollspy" data-offset="160" class="spec">

     <!-- navbar -->
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img class="logo" alt="interledger" src="/assets/ilp_icon.png"/></a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="/overview.html">Docs</a></li>
              <li><a href="/community.html">Community</a></li>
              <li><a href="/news.html">News</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a target="_blank" href="https://github.com/interledger">Github</a></li>
            </ul>
          </div>
        </div>
      </nav>

    <!-- docs overview section -->

    <div class="container docs-wrapper">
      <div class="row">
        <div id="sidebarContent">
          <nav class="col-sm-4" id="myScrollspy">
            <ul class="nav-fixed nav nav-sidebar">
              <div class="overview-back"><a href="/overview.html"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Back to Overview</a></div>
                <li class="nav-label">
                  <a href="./draft-1.html">ILP-RFC 0000 Draft 1</a>
                </li>
                <li>
                  <a href="./draft-1.html">Permalink to this Draft</a>
                </li>
                <li>
                  <a href="./">View the Latest Draft of ILP-RFC 0000</a>
                </li>
              
                <li class="nav-label">
                  <a href="#interledger-packets">Interledger Packets</a>
                </li>
              
                <li>
                  <a href="#ilp-prepare">ILP Prepare</a>
                </li>
              
                <li>
                  <a href="#ilp-fulfill">ILP Fulfill</a>
                </li>
              
                <li>
                  <a href="#ilp-reject">ILP Reject</a>
                </li>
              
                <li class="nav-label">
                  <a href="#ilp-addresses">ILP Addresses</a>
                </li>
              
                <li class="nav-label">
                  <a href="#amounts">Amounts</a>
                </li>
              
                <li class="nav-label">
                  <a href="#links">Links</a>
                </li>
              
                <li class="nav-label">
                  <a href="#link-relations">Link Relations</a>
                </li>
              
                <li class="nav-label">
                  <a href="#routing">Routing</a>
                </li>
              
                <li class="nav-label">
                  <a href="#special-addresses">Special Addresses</a>
                </li>
              
                <li class="nav-label">
                  <a href="#settlement">Settlement</a>
                </li>
              
                <li>
                  <a href="#plugin-interface">Plugin Interface</a>
                </li>
              
            </ul>
          </nav>
        </div>
        <div class="col-sm-8 markdown-body">
                      <h1 id="interledger-connector---requirements-specification">Interledger Connector - Requirements Specification</h1>
<p class="intro">This document defines the basic functions of an ILP Connector. </p>
<p>An ILP Connector is a node on the Interledger network that performs the necessary functions to route ILP packets between peers.</p>
<p>The document is specific to the requirements of a node that only operates at the ILP layer and does not concern itself with functionality in the higher protocol layers (e.g. STREAM, PSK2, etc). In other words, this document describes the functions of a node that is neither a sender nor receiver of ILP packets but rather a &quot;middlebox&quot;, to borrow some Internet terminology.</p>
<p>Such a node is often referred to as a <strong>connector</strong> as it provides connectivity between different networks.</p>
<h1 id="overview">Overview</h1>
<p>An ILP connector is very similar to a network router on an IP network. It has multiple incoming and outgoing links on which it sends and receives packets of data. Its primary function is to route incoming packets, on any links, to the appropriate outgoing link.</p>
<p>Where an ILP connector differs from an IP router is that it MUST be stateful. ILP packets come in request/reply pairs so a node that receives a request on one link, and then routes it out on another, MUST ensure it is able to match any reply it gets back on the outgoing link to the original request sent on that link. It MUST also route the reply back along the same incoming link on which it received the original incoming request.</p>
<p>The business logic of an ILP connector is also more sophisticated than an IP router, in that the connector operator is paid, per packet, by the sender of incoming packets to perform this function. It follows therefore, that the operator must also pay the next node for every packet it sends to it.</p>
<p>However, payment for forwarding a packet is only due if a <strong>valid</strong> response to a request is received <strong>within a predefined expiry</strong>. This implies that the connector must track the amounts owed by it and due to it for accepting and forwarding packets respectively. It must also reconcile the amounts owed to, and due from, peers and respond to (or initiate) external settlement events on those accounts.</p>
<h1 id="key-concepts">Key Concepts</h1>
<h2 id="interledger-packets">Interledger Packets</h2>
<p>ILP packets are not unlike IP packets, in that they are a well-defined octet-based encoding for a payload of data, encapsulated in an envelope with a set of well-known headers. </p>
<p>However, as ILP is a request/reply protocol there are 3 packet types (1 for requests and 2 types for replies), not 1 as in IP. The packet types are: </p>
<ul>
<li>ILP Prepare (request)</li>
<li>ILP Fulfill (response), and</li>
<li>ILP Reject (error)</li>
</ul>
<p>Packets use Canonical OER (Octet Encoding Rules) encoding and have the following headers:</p>
<h3 id="ilp-prepare">ILP Prepare</h3>
<table class="table table-striped">
<thead>
<tr>
<th>Header</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>amount</td>
<td>UInt64</td>
<td>Amount offered to forward the packet. Currency and scale are implied by the link on which the packet is sent.</td>
</tr>
<tr>
<td>expiresAt</td>
<td>Timestamp</td>
<td>The time when the offer to pay to forward the packet expires.</td>
</tr>
<tr>
<td>executionCondition</td>
<td>UInt256</td>
<td>A SHA-256 hash digest of the fulfillment which will be sent in the ILP Fulfill (response) packet.</td>
</tr>
<tr>
<td>destination</td>
<td>ILP Address</td>
<td>Address of the node that the packet must be delivered to in order to get a valid response (ILP Fulfill).</td>
</tr>
</tbody>
</table>
<h3 id="ilp-fulfill">ILP Fulfill</h3>
<table class="table table-striped">
<thead>
<tr>
<th>Header</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>fulfillment</td>
<td>UInt256</td>
<td>The pre-image of the condition in the corresponding ILP Prepare (request) packet.</td>
</tr>
</tbody>
</table>
<h3 id="ilp-reject">ILP Reject</h3>
<table class="table table-striped">
<thead>
<tr>
<th>Header</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>code</td>
<td>3-char IA5String</td>
<td>An ILP Error code.</td>
</tr>
<tr>
<td>triggeredBy</td>
<td>ILP Address</td>
<td>The node that triggered the error.</td>
</tr>
<tr>
<td>message</td>
<td>UTF-8 String</td>
<td>Human-readable message for debugging purposes.</td>
</tr>
</tbody>
</table>
<p>All packets have a <code>data</code> payload which is a variable length octet string up to 32767 bytes.</p>
<p>Like IP packets, the most important header is the <strong>destination.</strong> This is the ILP Address of the node that should receive the packet. However, unlike IP packets, the address of the sender is NOT recorded in the headers. This is because a response packet (ILP Fulfill or ILP Reject) MUST be routed back along exactly the same route as the original request (ILP Prepare) so a receiver has no need for the sender&apos;s address as they can simply provide responses in the payload of the response packet.</p>
<p>To correctly route responses, an ILP connector must ensure it persists the state of an ILP Prepare packet, at least as long as specified in the <strong>expiresAt</strong> header. When a reply to the ILP Prepare is received (either an ILP Fulfill or ILP Reject) from the outgoing link it MUST be routed down the same link on which the ILP Prepare was received. </p>
<p>If the packet expires before a response is received from the outgoing link then the connecter MUST send an ILP Reject packet as the reply on the incoming link. Reply packets that are received after the request has expired can be discarded.</p>
<p>The link protocol used to communicate with peers MUST allow the node to match requests and replies such that when a reply (ILP Fulfill or ILP Reject) is received from an outgoing link it can be matched to the original.</p>
<h2 id="ilp-addresses">ILP Addresses</h2>
<p>An ILP packet is addressed using an ILP Address. The ILP Addressing scheme is similar to the IP addressing scheme (both IPv4 and IPv6) in that the scheme is a hierarchical address space where routing is done based on (primarily) longest prefix match of a destination address against the address range prefixes in the node&apos;s routing table.</p>
<p>Unlike IP addresses, ILP addresses are variable in size and encoded as IA7 (ASCII) strings of dot (<code>.</code>) separated segments. The valid characters in an address segment are alphanumeric plus Underscore (<code>_</code>), Tilde (<code>~</code>) and Hyphen (<code>-</code>) and are case sensitive which allows base64 encoded data to be encoded into address segments.</p>
<p>More details on ILP Addresses are in <a href="https://interledger.org/rfcs/0015-ilp-addresses/">ILP RFC 15</a>.</p>
<h2 id="amounts">Amounts</h2>
<p>Amounts in ILP are simple and are represented as 64-bit unsigned integers. As such an amount will have an associated currency and scale which specifies how the integer representation can be converted to a more user friendly decimal form when required.</p>
<p>For example a link between two peers on the network may be settled in US dollars and the peers may decide they wish to allow precision up to 100ths of a cent. In this case the link will be configured by both peers to use the currency USD and the scale of 4. An ILP packet with an amount of 12345 is $1.23,45 or one dollar and twenty-three point four five cents.</p>
<p>For more details on how payments, clearing and settlement are done in ILP see <a href="../0032-peering-clearing-settlement">IL-RFC 32 Peering, Clearing and Settlement</a></p>
<h1 id="requirements">Requirements</h1>
<h2 id="links">Links</h2>
<p>A node must have one or more links to peer nodes with whom it will exchange ILP packets. These links can use any protocol to exchange the packets as long as both peers are able to <strong>correctly correlate which packets are responses to a specific previous request</strong>.</p>
<p>When two peers establish a link they must <strong>agree on the settlement currency and scale for packets exchanged over that link</strong>. The amount in an ILP packet is an unsigned 64-bit number, therefore when a node receives a packet it must infer the currency and scale of the amount from the link on which it was received.</p>
<p>An example of a protocol that can be used between nodes is the <a href="../0023-bilateral-transfer-protocol/">Bilateral Transfer Protocol (BTP)</a>.</p>
<h2 id="link-relations">Link Relations</h2>
<p>Each link will have one of three relation types which reflect how the node is related to the peer on the other side of the link, these are <strong>peer</strong>, <strong>parent</strong> or <strong>child</strong>. The network graph is organized in a tiered hierarchy, similar to the Internet, reflecting these relationships. Large, high volume connectors are peered with one another to form the backbone of the network. Smaller nodes will have links to these &quot;tier 1&quot; nodes and the link will be of type child from the perspective of the tier 1 node and of type parent from the perspective of the smaller node.</p>
<p>A node MUST only have one link of type parent or, if it has multiple, only one configured to use the IL-DCP protocol upon establishing the link, to request an address from the parent.</p>
<p>A node that has links of type child must host an IL-DCP service to allow the nodes on those links to request addresses. Generally these will be sub-addresses of the node&apos;s own address however this is not a requirement.</p>
<h2 id="routing">Routing</h2>
<p>A node must maintain routing information that allows it to determine where to forward incoming packets. Packets arrive on one link and the node must forward the packet out on another link. The logic required to make this determination is not specified but the node SHOULD attempt to forward a packet such that it has the highest probability of being delivered to the node identified by the destination address packet header.</p>
<p>Generally a node will prefer to route packets to a child, over a peer, over a parent as this will likely be the most lucrative for the node. (See <a href="https://people.eecs.berkeley.edu/~sylvia/cs268-2016/papers/gao-rexford.pdf">Gao-Rexford</a>)</p>
<p>Most nodes will maintain a routing table that tracks its <strong>links</strong>, the <strong>address-spaces</strong> that can be delivered to over those links (identified by an address prefix) and the <strong>link relation</strong> of the link. They will attempt to match the destination address of incoming packets with an address prefix in the table to determine the link to forward the packet over. The data in the table is maintained through exchange of routing data by the node with all of its peers.</p>
<p>When a node&apos;s routing data changes in such a way that it is necessary to notify its peers the node will broadcast the changes to all peers. Likewise, the node will continuously be processing incoming updates from its peers.</p>
<h2 id="special-addresses">Special Addresses</h2>
<p><strong><code>peer.*</code></strong></p>
<p>Routing data updates, IL-DCP and other peer-to-peer protocols use ILP packets where the destination address is in the <code>peer.*</code> address-space. Nodes that receive packets in the peer.* address-space MUST NOT forward these packets to another node.</p>
<p><strong><code>test.*</code>, <code>test1.*</code>, <code>test2.*</code>, and <code>test3.*</code></strong></p>
<p>A node MUST run either in a test network or on the live network but never on both. If a node is running on the test network it MUST reject all packets in the global address-space, <code>g.*</code>. Likewise, if a node is running on the live network it MUST reject any packets with addresses in the <code>test.*</code>, <code>test1.*</code>, <code>test2.*</code>, or <code>test3.*</code> address-spaces.</p>
<h2 id="settlement">Settlement</h2>
<p>When a node routes a packet it is accepting an offer, from the requesting peer, to pay for proof-of-delivery of that packet. When it returns a valid response to the requesting peer (an ILP Fulfill packet with the correct fulfillment) before the expiry of the request, this creates an obligation between the peers. The requesting peer now owes the forwarding peer the amount specified in the request packet.</p>
<p>According to an agreed schedule the two peers will reconcile and settle the obligations created between them as a result of successfully forwarding ILP packets. It is important to note that this process is a bilateral concern and does not impact the settlement of obligations between other nodes involved in forwarding that packet.</p>
<p>The specific schedule and mechanism for doing this will be specific to the settlement system used by the peers (e.g. payment channels on a distributed ledger, traditional wire transfers via the banking system, etc.), therefore the functionality required to do this is not included in the core node but rather in settlement-system-specific plugins or adaptors.</p>
<p>It is necessary for the connector to have a view of the current outstanding obligations with the peer (the peer&apos;s account balance) in order to apply appropriate risk management measures when processing packets from the peer.</p>
<p>The logic that determines when to perform a settlement is currently implemented within the connector in the reference implementation (as opposed to in the plugin) and as such the connector must instruct the plugin when to perform a settlement. This reduces the outstanding obligations with the peer to a limit that the connector considers safe such that it can forward further packets for the peer.</p>
<p>Where the plugin is managing the balance of the peer it may be possible to simplify the interface between the connector and the plugin to simply be the exchange of ILP packets however it is likely that the node will still need to have a view of the peer&apos;s unsettled balance to allow it to apply risk management measures of its own.</p>
<h3 id="plugin-interface">Plugin Interface</h3>
<p>The interface between these plugins and the node exposes the following functions:</p>
<ul>
<li>Send ILP Packet</li>
<li>Receive ILP Packet</li>
<li>Notification of a settlement event</li>
<li><p>Request to perform settlement</p>
<p>A concrete implementation of this interface is defined for the reference Javascript node implementation in the <a href="../0024-ledger-plugin-interface-2">Ledger Plugin Interface v2</a>.</p>
</li>
</ul>

        </div>
      </div>

    </div> <!-- /container -->

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="col-sm-4 col-xs-12">
              <p>Copyright © 2018<br/> W3C Interledger Payments CG</p>
            </div>
            <div class="col-sm-4 col-xs-12">
              <p class="text-center">See list of <a target="_blank" href="https://www.w3.org/community/interledger/participants">Contributors</a></p>
            </div>
            <div class="col-sm-4 col-xs-12">
              <p class="pull-right">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68500608-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
